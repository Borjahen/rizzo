"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var config_json_1 = __importDefault(require("../../config.json"));
var tracker_1 = require("../../tracker");
var dataLayer_1 = require("../../dataLayer");
var writeAuthDataToDataLayerInitPayload_1 = require("./writeAuthDataToDataLayerInitPayload");
var analyticsPath = config_json_1.default.analyticsPath, globalPropsScopeName = config_json_1.default.globalPropsScopeName;
var analyticsObject = dataLayer_1.getAnalyticsObject(analyticsPath);
var invoked = "asyncUserStatusWrapperHasBeenInvoked";
var callbackName = "asyncUserStatusWrapperOnLoad";
/**
 * This script will:
 * 1.) request user auth details from dotcom-connect
 *     (this is essentially asyncUserStatusWrapper written in code instead of as a string)
 * 2.) upon receiving them, write them to `GLOBAL_UI_INITIAL_PROPS`.
 * 3.) add relevant details to the `dataLayer-initialized` payload, and
 * 4.) initialize tracking containers (as of writing, this consists of executing the GTM snippet).
 */
window[callbackName] = function (user) {
    if (user) {
        window[globalPropsScopeName] = window[globalPropsScopeName] || {};
        window[globalPropsScopeName].auth = window[globalPropsScopeName].auth || {
            isUserSignedIn: !!user.id,
            user: user,
        };
    }
    writeAuthDataToDataLayerInitPayload_1.writeAuthDataToDataLayerInitPayload();
    tracker_1.makeTracker().initializeContainers();
    delete window[callbackName];
};
if (!analyticsObject[invoked]) {
    var script = document.createElement("script");
    script.src = "https://connect.lonelyplanet.com/users/status.json?callback=" + callbackName;
    document.getElementsByTagName("head")[0].appendChild(script);
    analyticsObject[invoked] = true;
}
